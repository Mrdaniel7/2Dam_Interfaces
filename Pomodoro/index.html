<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Grove 3D</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #f0f0f0;
            --primary-color: #4a90e2;
            --secondary-color: #e24a4a;
            --ui-bg: rgba(26, 26, 26, 0.8);
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        #bg {
            position: fixed;
            top: 0;
            left: 0;
            outline: none;
            width: 100%;
            height: 100%;
        }

        #ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allows clicks to pass through to the canvas unless on a UI element */
        }
        
        #ui-container > * {
            pointer-events: auto; /* Re-enable pointer events for UI elements */
        }

        #timer-display {
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(6rem, 20vw, 12rem);
            font-weight: 700;
            color: rgba(255, 255, 255, 0.85);
            text-shadow: 0 0 20px rgba(0,0,0,0.5);
            user-select: none;
        }

        .controls {
            position: absolute;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
            display: flex;
            gap: 15px;
            background-color: var(--ui-bg);
            padding: 10px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Show controls on hover over the body/container */
        body:hover .controls,
        body:hover #timer-display,
        body:hover #versus-scoreboard {
            opacity: 1;
            visibility: visible;
        }
        
        body:hover #sound-panel.active {
             opacity: 1;
            visibility: visible;
        }

        /* For smaller screens (mobile), make controls always visible */
        @media (max-width: 768px), (pointer: coarse) {
            .controls, #timer-display, #versus-scoreboard {
                opacity: 1;
                visibility: visible;
            }
        }


        #main-controls {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        #top-right-controls {
            top: 20px;
            right: 20px;
            align-items: center;
        }
        
        #top-left-controls {
            top: 20px;
            left: 20px;
        }
        
        #speed-controls {
            bottom: 20px;
            left: 20px;
        }

        .speed-button {
            width: auto;
            padding: 0 15px;
            border-radius: 10px;
            height: 44px;
        }

        .speed-button.active, .sound-button.active {
            background-color: var(--primary-color);
            color: white;
        }


        .control-button, .modal-button {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        
        .control-button {
             width: 44px;
            height: 44px;
            border-radius: 50%;
        }

        .control-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .control-button svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        
        #sound-panel {
            position: absolute;
            top: 80px;
            left: 20px;
            width: 220px;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
        }

        #sound-panel.active {
             opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        #sound-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: space-around;
        }

        #volume-slider {
            width: 90%;
            margin-top: 10px;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1000;
            pointer-events: auto;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            position: relative;
            background-color: var(--ui-bg);
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-content h2, .modal-content h3 {
            margin-bottom: 1rem;
            text-align: center;
            font-weight: bold;
        }

        .modal-content .form-group {
            margin-bottom: 15px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 5px;
            color: rgba(255,255,255,0.7);
        }

        .modal-content input[type="number"], .modal-content input[type="text"], .modal-content select, .modal-content textarea, .modal-content input[type="file"] {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background-color: rgba(0,0,0,0.3);
            color: var(--text-color);
            font-size: 1rem;
        }
        
        .modal-button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            background-color: var(--primary-color);
            margin-top: 10px;
        }
        
        .modal-button.secondary {
            background-color: #555;
        }
        
        .modal-button:hover {
            transform: scale(1.03);
            opacity: 0.9;
        }

        .modal-button:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
        }

        #task-list {
            list-style: none;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        #task-list li {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        
        #task-list li:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        #task-list li.completed span {
            text-decoration: line-through;
            opacity: 0.5;
        }
        
        #task-list input[type="checkbox"] {
           margin-right: 10px;
           min-width: 16px;
           min-height: 16px;
         }

        #task-list .delete-task {
            margin-left: auto;
            background: none;
            border: none;
            color: #ff6b6b;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        
        #task-list li:hover .delete-task {
            opacity: 1;
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        #ai-tutor-loading .spinner {
            border-color: rgba(255,255,255,0.2);
            border-top-color: var(--primary-color);
        }

        #language-btn {
            width: 2.5rem;
            height: 1.75rem;
            background-size: cover;
            background-position: center;
            border-radius: 0.25rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dropdown-menu {
            position: absolute;
            top: 54px;
            width: 180px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0;
            padding: 5px;
            background-color: var(--ui-bg);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 20;
        }
        #language-dropdown {
            right: 0;
        }
        #main-menu-dropdown {
            left: 0;
        }
        .menu-option {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s;
            font-size: 0.9rem;
        }
        .menu-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .menu-option svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
            flex-shrink: 0;
        }

        .hidden {
            display: none !important;
        }

        .relative {
            position: relative;
        }
        
        #game-code-display {
            background-color: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 4px;
            margin: 20px 0;
            cursor: pointer;
            border: 1px dashed rgba(255,255,255,0.3);
        }

        #game-code-display:hover {
            background-color: rgba(0,0,0,0.6);
        }
        
        #game-code-copy-feedback {
            text-align: center;
            font-size: 0.9rem;
            color: var(--primary-color);
            opacity: 0;
            transition: opacity 0.3s;
        }

        #versus-scoreboard {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 30px;
            background-color: var(--ui-bg);
            padding: 10px 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .player-score {
            text-align: center;
        }

        .player-score h4 {
            font-size: 1rem;
            margin-bottom: 5px;
        }
        
        .player-score p {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        #player1-score h4 { color: var(--primary-color); }
        #player2-score h4 { color: var(--secondary-color); }

    </style>
</head>
<body>

    <canvas id="bg"></canvas>

    <div id="ui-container">
        <div id="timer-display">25:00</div>
        
        <div id="versus-scoreboard" class="hidden">
            <div id="player1-score" class="player-score">
                <h4 data-translate-key="host">Anfitri√≥n</h4>
                <p>0 üçÖ</p>
            </div>
             <div id="player2-score" class="player-score">
                <h4 data-translate-key="guest">Invitado</h4>
                <p>0 üçÖ</p>
            </div>
        </div>

        <div id="main-controls" class="controls">
            <button id="play-pause-btn" class="control-button" title="Play/Pause">
                <svg id="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                <svg id="pause-icon" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
            </button>
             <button id="reset-btn" class="control-button" title="Reset">
                <svg viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"></path></svg>
            </button>
        </div>

        <div id="top-right-controls" class="controls">
            <button id="ai-tutor-btn" class="control-button font-bold text-lg" title="Tutor IA">AI</button>
            
            <div class="relative">
                <button id="language-btn" title="Cambiar Idioma"></button>
                <div id="language-dropdown" class="dropdown-menu hidden">
                    <button data-lang="es" class="menu-option"><span class="w-6 h-4 bg-cover bg-center rounded-sm" style="background-image: url('https://flagcdn.com/w40/es.png');"></span><span class="flex-1">Espa√±ol</span></button>
                    <button data-lang="en" class="menu-option"><span class="w-6 h-4 bg-cover bg-center rounded-sm" style="background-image: url('https://flagcdn.com/w40/us.png');"></span><span class="flex-1">English</span></button>
                    <button data-lang="fr" class="menu-option"><span class="w-6 h-4 bg-cover bg-center rounded-sm" style="background-image: url('https://flagcdn.com/w40/fr.png');"></span><span class="flex-1">Fran√ßais</span></button>
                    <button data-lang="zh" class="menu-option"><span class="w-6 h-4 bg-cover bg-center rounded-sm" style="background-image: url('https://flagcdn.com/w40/cn.png');"></span><span class="flex-1">‰∏≠Êñá</span></button>
                    <button data-lang="hi" class="menu-option"><span class="w-6 h-4 bg-cover bg-center rounded-sm" style="background-image: url('https://flagcdn.com/w40/in.png');"></span><span class="flex-1">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</span></button>
                </div>
            </div>

            <button id="fullscreen-btn" class="control-button" title="Pantalla Completa">
                <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"></path></svg>
            </button>
        </div>

        <div id="top-left-controls" class="controls">
            <div class="relative">
                <button id="main-menu-btn" class="control-button" title="Men√∫">
                    <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
                </button>
                <div id="main-menu-dropdown" class="dropdown-menu hidden">
                    <button id="settings-btn" class="menu-option" title="Configuraci√≥n">
                        <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24-.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59-1.69.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg>
                        <span data-translate-key="settingsTitle">Configuraci√≥n</span>
                    </button>
                    <button id="tasks-btn" class="menu-option" title="Tareas">
                        <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
                        <span data-translate-key="todoTitle">Lista de Tareas</span>
                    </button>
                    <button id="multiplayer-btn" class="menu-option" title="Multijugador" disabled>
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                        <span data-translate-key="multiplayer">Multijugador</span>
                    </button>
                    <button id="biome-btn" class="menu-option" title="Cambiar Bioma">
                        <svg viewBox="0 0 24 24"><path d="M15 6l-2.5 4L10 4l-5 12h16l-6-8z"></path></svg>
                        <span data-translate-key="biome">Bioma</span>
                    </button>
                    <button id="sound-menu-btn" class="menu-option" title="Sonido Ambiente">
                       <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                       <span data-translate-key="music">M√∫sica</span>
                   </button>
                </div>
            </div>
        </div>
        
        <div id="speed-controls" class="controls">
            <button class="speed-button active" data-speed="1">x1</button>
            <button class="speed-button" data-speed="2">x2</button>
            <button class="speed-button" data-speed="5">x5</button>
            <button class="speed-button" data-speed="10">x10</button>
        </div>

        <div id="sound-panel" class="controls">
            <div id="sound-buttons">
                <button class="control-button sound-button" data-sound="rain" title="Lluvia">
                    <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 19H6c-2.21 0-4-1.79-4-4s1.79-4 4-4h.71C7.37 9.69 9.54 8 12 8c2.65 0 4.88 1.99 5.29 4.58A3.003 3.003 0 0 1 21 14c0 1.66-1.34 3-3 3h-1v2z"/></svg>
                </button>
                <button class="control-button sound-button" data-sound="forest" title="Bosque">
                   <svg viewBox="0 0 24 24"><path d="M22.2,8.6c-0.1-0.1-0.2-0.2-0.4-0.2c-0.3-0.2-0.7-0.1-0.9,0.1c-1.3,1-3.1,1.5-4.9,1.5c-1,0-2-0.2-2.9-0.5 c-0.5-0.2-1-0.1-1.4,0.3l-1,1c-0.2,0.2-0.2,0.5,0,0.7s0.5,0.2,0.7,0l1-1c0.1-0.1,0.2-0.1,0.3-0.1c0.8,0.3,1.7,0.4,2.6,0.4 c1.6,0,3.3-0.5,4.5-1.4c0.3-0.2,0.7-0.2,0.9,0.1C22.1,10.9,22.4,10.1,22.2,8.6z M17,14c-1.7,0-3-1.3-3-3s1.3-3,3-3s3,1.3,3,3 S18.7,14,17,14z M7,10C5.3,10,4,8.7,4,7s1.3-3,3-3s3,1.3,3,3S8.7,10,7,10z"/></svg>
                </button>
                <button class="control-button sound-button" data-sound="white_noise" title="Ruido Blanco">
                    <svg viewBox="0 0 24 24"><path d="M3 9h2v6H3V9zm4 0h2v6H7V9zm4 0h2v6h-2V9zm4 0h2v6h-2V9zm4 0h2v6h-2V9z"/></svg>
                </button>
                <button class="control-button sound-button active" data-sound="mute" title="Silencio">
                    <svg viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
                </button>
            </div>
            <input type="range" id="volume-slider" min="0" max="100" value="50">
        </div>

    </div>
    
    <!-- Settings Modal --><div id="settings-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" data-target="settings-modal">&times;</button>
            <h2 data-translate-key="settingsTitle">Configuraci√≥n</h2>
            <div class="form-group">
                <label data-translate-key="focusLabel">Enfoque</label>
                <input type="number" id="focus-duration" value="25" min="1">
            </div>
            <div class="form-group">
                <label data-translate-key="shortBreakLabel">Descanso Corto</label>
                <input type="number" id="short-break-duration" value="5" min="1">
            </div>
            <div class="form-group">
                <label data-translate-key="longBreakLabel">Descanso Largo</label>
                <input type="number" id="long-break-duration" value="15" min="1">
            </div>
            <hr style="border-color: rgba(255,255,255,0.2); margin: 20px 0;">
            <h3 data-translate-key="saveLoadGame">Guardar/Cargar Partida</h3>
            <p style="font-size: 0.9rem; color: #aaa; margin-bottom: 15px;" data-translate-key="saveLoadDesc">Exporta el estado de tu partida multijugador para continuarla m√°s tarde.</p>
            <div class="form-group">
                <button id="export-game-btn" class="modal-button secondary" data-translate-key="exportGame">Exportar Partida</button>
            </div>
             <div class="form-group">
                <label for="import-game-input" data-translate-key="importGame">Importar Partida (Anfitri√≥n)</label>
                <input type="file" id="import-game-input" accept=".json" style="padding: 5px;">
            </div>
        </div>
    </div>
    
    <!-- Tasks Modal --><div id="tasks-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" data-target="tasks-modal">&times;</button>
            <h2 data-translate-key="todoTitle">Lista de Tareas</h2>
            <ul id="task-list"></ul>
            <div class="form-group">
                <input type="text" id="new-task-input" placeholder="A√±adir nueva tarea..." data-translate-key="todoPlaceholder">
            </div>
        </div>
    </div>

    <!-- AI Modal -->
    <div id="ai-tutor-modal" class="modal">
         <div class="modal-content">
            <button class="modal-close-btn" data-target="ai-tutor-modal">&times;</button>
            <h3 class="text-lg font-bold mb-4" data-translate-key="aiTutorTitle">‚ú® Tutor IA</h3>
            <p class="text-sm text-secondary mb-4" data-translate-key="aiTutorDescription">¬øAtascado en un problema? Descr√≠belo y la IA te dar√° una explicaci√≥n simple.</p>
            <textarea id="ai-tutor-prompt-input" rows="4" class="w-full p-2 rounded-md bg-primary-light border border-custom text-sm mb-4" placeholder="Ej: ¬øPor qu√© el cielo es azul?" data-translate-key="aiTutorPlaceholder"></textarea>
            <button id="ai-tutor-generate-btn" class="w-full font-bold py-2 px-4 rounded-lg text-white transition-transform transform hover:scale-105" style="background-color: var(--primary-color);">
                <span data-translate-key="aiTutorGenerateBtn">Explicar Concepto</span>
            </button>
            <div id="ai-tutor-result-container" class="mt-4 max-h-48 overflow-y-auto">
                <div id="ai-tutor-loading" class="hidden flex-col items-center justify-center text-center">
                     <div class="spinner w-8 h-8 border-4 rounded-full animate-spin"></div>
                    <p class="text-sm text-secondary" data-translate-key="aiTutorLoading">Pensando...</p>
                </div>
                <div id="ai-tutor-output" class="text-left text-sm space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Multiplayer Modal -->
    <div id="multiplayer-modal" class="modal">
        <div class="modal-content">
             <button class="modal-close-btn" data-target="multiplayer-modal">&times;</button>

            <!-- Initial View -->
            <div id="multiplayer-initial">
                <h2 data-translate-key="multiplayer">Multijugador</h2>
                <button id="host-btn" class="modal-button" data-translate-key="createGame">Crear Partida</button>
                <button id="join-btn" class="modal-button secondary" data-translate-key="joinGame">Unirse a Partida</button>
            </div>

            <!-- Host: Mode Selection -->
            <div id="multiplayer-host-options" class="hidden">
                <h2 data-translate-key="selectMode">Seleccionar Modo</h2>
                <button id="coop-mode-btn" class="modal-button">ü§ù <span data-translate-key="cooperativeMode">Cooperativo</span></button>
                <button id="versus-mode-btn" class="modal-button secondary">‚öîÔ∏è <span data-translate-key="versusMode">Lucha</span></button>
                <button id="back-to-initial-btn" class="modal-button" style="background-color:#6c757d; margin-top:20px;" data-translate-key="back">Volver</button>
            </div>

            <!-- Host: Waiting for Player -->
            <div id="multiplayer-waiting" class="hidden">
                <h2 data-translate-key="waitingForPlayer">Esperando jugador...</h2>
                <p style="text-align:center; margin-bottom:1rem;" data-translate-key="shareCode">Comparte este c√≥digo con un amigo:</p>
                <div id="game-code-display" title="Haz clic para copiar">C√ìDIGO</div>
                <p id="game-code-copy-feedback" data-translate-key="copied">¬°Copiado!</p>
            </div>
            
            <!-- Guest: Join Game -->
            <div id="multiplayer-join" class="hidden">
                <h2 data-translate-key="joinGame">Unirse a Partida</h2>
                <div class="form-group">
                    <label for="game-code-input" data-translate-key="enterCode">Introduce el c√≥digo de la partida</label>
                    <input type="text" id="game-code-input" placeholder="C√ìDIGO-AQU√ç">
                </div>
                <button id="join-game-submit-btn" class="modal-button" data-translate-key="join">Unirse</button>
                 <button id="back-to-initial-btn-2" class="modal-button" style="background-color:#6c757d; margin-top:10px;" data-translate-key="back">Volver</button>
            </div>
        </div>
    </div>


    <!-- Load Tone.js via a classic script tag before the module script --><script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>
    <!-- Improved Perlin Noise library for more natural terrain --><script src="https://cdn.jsdelivr.net/npm/simplex-noise@2.4.0/simplex-noise.min.js"></script>

    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
        }
    }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('bg');
        const timerDisplay = document.getElementById('timer-display');
        
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const resetBtn = document.getElementById('reset-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const tasksBtn = document.getElementById('tasks-btn');
        const biomeBtn = document.getElementById('biome-btn');
        const soundMenuBtn = document.getElementById('sound-menu-btn');
        const soundPanel = document.getElementById('sound-panel');
        const volumeSlider = document.getElementById('volume-slider');
        
        // Modals
        const settingsModal = document.getElementById('settings-modal');
        const tasksModal = document.getElementById('tasks-modal');
        const workDurationInput = document.getElementById('focus-duration');
        const shortBreakDurationInput = document.getElementById('short-break-duration');
        const longBreakDurationInput = document.getElementById('long-break-duration');
        
        // AI Tutor
        const aiTutorModal = document.getElementById('ai-tutor-modal');
        const aiTutorBtn = document.getElementById('ai-tutor-btn');
        const aiTutorGenerateBtn = document.getElementById('ai-tutor-generate-btn');
        const aiTutorPromptInput = document.getElementById('ai-tutor-prompt-input');
        const aiTutorLoading = document.getElementById('ai-tutor-loading');
        const aiTutorOutput = document.getElementById('ai-tutor-output');

        // Language
        const languageBtn = document.getElementById('language-btn');
        const languageDropdown = document.getElementById('language-dropdown');
        
        // Main Menu
        const mainMenuBtn = document.getElementById('main-menu-btn');
        const mainMenuDropdown = document.getElementById('main-menu-dropdown');

        // Tasks
        const newTaskInput = document.getElementById('new-task-input');
        const taskList = document.getElementById('task-list');
        
        // Multiplayer UI
        const multiplayerBtn = document.getElementById('multiplayer-btn');
        const multiplayerModal = document.getElementById('multiplayer-modal');
        const multiplayerInitialView = document.getElementById('multiplayer-initial');
        const multiplayerHostView = document.getElementById('multiplayer-host-options');
        const multiplayerWaitingView = document.getElementById('multiplayer-waiting');
        const multiplayerJoinView = document.getElementById('multiplayer-join');
        const hostBtn = document.getElementById('host-btn');
        const joinBtn = document.getElementById('join-btn');
        const coopModeBtn = document.getElementById('coop-mode-btn');
        const versusModeBtn = document.getElementById('versus-mode-btn');
        const gameCodeDisplay = document.getElementById('game-code-display');
        const gameCodeInput = document.getElementById('game-code-input');
        const joinGameSubmitBtn = document.getElementById('join-game-submit-btn');
        const versusScoreboard = document.getElementById('versus-scoreboard');
        const exportGameBtn = document.getElementById('export-game-btn');
        const importGameInput = document.getElementById('import-game-input');


        // --- 3D SCENE SETUP ---
        let scene, camera, renderer, controls, floor, ambientLight, sunLight, skybox, sunMesh;
        let grove = [];
        const shrubsGroup = new THREE.Group();
        const flowersGroup = new THREE.Group();
        
        const simplex = new SimplexNoise();

        // --- FIREBASE & APP STATE ---
        let db, auth, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let currentGameState = {
            inMultiplayer: false,
            isHost: false,
            gameId: null,
            mode: null,
            unsubscribe: null,
        };

        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 20, 50);

            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.minDistance = 5;
            controls.maxDistance = 80; 
            controls.maxPolarAngle = Math.PI / 2.1;

            ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
            sunLight.position.set(50, 50, -50);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            sunLight.shadow.camera.near = 0.5;
            sunLight.shadow.camera.far = 200;
            const shadowCamSize = 120;
            sunLight.shadow.camera.left = -shadowCamSize;
            sunLight.shadow.camera.right = shadowCamSize;
            sunLight.shadow.camera.top = shadowCamSize;
            sunLight.shadow.camera.bottom = -shadowCamSize;
            scene.add(sunLight);

            const floorSize = 200;
            const floorSegments = 100;
            const floorGeometry = new THREE.PlaneGeometry(floorSize, floorSize, floorSegments, floorSegments);
            const floorMaterial = new THREE.MeshStandardMaterial({ 
                vertexColors: true,
                roughness: 0.8,
                metalness: 0.1
            });
            
            const vertices = floorGeometry.attributes.position;
            const colors = [];
            const color = new THREE.Color();
            
            const grassColor = new THREE.Color(0x4CAF50);
            const darkGrassColor = new THREE.Color(0x388E3C);
            const rockColor = new THREE.Color(0x757575);
            
            for (let i = 0; i < vertices.count; i++) {
                const x = vertices.getX(i);
                const y = vertices.getY(i);
                
                const height = getHeightAt(x, y); 
                vertices.setZ(i, height);
                
                const heightRatio = Math.max(0, height / 20);
                if (heightRatio < 0.3) {
                    color.copy(darkGrassColor).lerp(grassColor, heightRatio / 0.3);
                } else {
                    color.copy(grassColor).lerp(rockColor, (heightRatio - 0.3) / 0.7);
                }

                colors.push(color.r, color.g, color.b);
            }
            floorGeometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            floorGeometry.computeVertexNormals();

            floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);
            
            scene.add(shrubsGroup);
            scene.add(flowersGroup);
            addVegetation();

            const sunGeometry = new THREE.SphereGeometry(7, 32, 32);
            const sunMaterial = new THREE.MeshBasicMaterial({ color: 0xFDB813 });
            sunMesh = new THREE.Mesh(sunGeometry, sunMaterial);
            sunMesh.position.set(100, 60, -150);
            scene.add(sunMesh);

            const sunPointLight = new THREE.PointLight(0xFDB813, 0.5, 300);
            sunMesh.add(sunPointLight);

            const skyGeometry = new THREE.BoxGeometry(1000, 1000, 1000);
            const skyMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    topColor: { value: new THREE.Color() },
                    bottomColor: { value: new THREE.Color() },
                },
                vertexShader: `
                    varying vec3 vWorldPosition;
                    void main() {
                        vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
                        vWorldPosition = worldPosition.xyz;
                        gl_Position = projectionMatrix * viewMatrix * worldPosition;
                        gl_Position.z = gl_Position.w;
                    }
                `,
                fragmentShader: `
                    uniform vec3 topColor;
                    uniform vec3 bottomColor;
                    varying vec3 vWorldPosition;
                    void main() {
                        float h = normalize(vWorldPosition).y;
                        gl_FragColor = vec4(mix(bottomColor, topColor, max(pow(max(h, 0.0), 0.8), 0.0)), 1.0);
                    }
                `,
                side: THREE.BackSide,
            });
            skybox = new THREE.Mesh(skyGeometry, skyMaterial);
            scene.add(skybox);

            changeBiome();
        }

        // --- POMODORO LOGIC ---
        let state = {
            isRunning: false,
            timerId: null,
            mode: 'focus', 
            workDuration: 25 * 60,
            shortBreakDuration: 5 * 60,
            longBreakDuration: 15 * 60,
            currentTime: 25 * 60,
            pomodoroCount: 0,
            timeScale: 1,
            currentLang: 'es'
        };
        
        function updateDurations() {
            state.workDuration = parseInt(workDurationInput.value) * 60;
            state.shortBreakDuration = parseInt(shortBreakDurationInput.value) * 60;
            state.longBreakDuration = parseInt(longBreakDurationInput.value) * 60;
            resetTimer();
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        function updateTimerDisplay() {
            timerDisplay.textContent = formatTime(state.currentTime);
            document.title = `${formatTime(state.currentTime)} - Focus Grove`;
        }

        function switchMode(newMode) {
            state.mode = newMode;
            switch (newMode) {
                case 'focus':
                    state.currentTime = state.workDuration;
                    break;
                case 'shortBreak':
                    state.currentTime = state.shortBreakDuration;
                    break;
                case 'longBreak':
                    state.currentTime = state.longBreakDuration;
                    break;
            }
            updateTimerDisplay();
        }

        async function timerTick() {
            state.currentTime--;
            updateTimerDisplay();

            // Grow a tree every minute during a focus session.
            // This triggers when the timer shows xx:00, including the final 00:00.
            if (state.mode === 'focus' && state.currentTime % 60 === 0 && state.currentTime < state.workDuration) {
                // No need to await, let it grow in the background
                growATree({ isSpecial: false, taskId: null });
            }

            if (state.currentTime <= 0) {
                // IMPORTANT FIX: Pause timer immediately to prevent multiple triggers
                pauseTimer(); 
                playNotification();

                if (state.mode === 'focus') {
                    state.pomodoroCount++;
                    // The final tree is grown by the logic above when currentTime becomes 0.
                    
                    if (state.pomodoroCount > 0 && state.pomodoroCount % 4 === 0) {
                        switchMode('longBreak');
                    } else {
                        switchMode('shortBreak');
                    }
                } else {
                    switchMode('focus');
                }
            }
        }

        function startTimer() {
            if (state.isRunning) return;
            startAudioContext();
            state.isRunning = true;
            if(state.timerId) clearInterval(state.timerId);
            state.timerId = setInterval(timerTick, 1000 / state.timeScale);
            playIcon.style.display = 'none';
            pauseIcon.style.display = 'block';
            toggleAmbientSound(true);
        }

        function pauseTimer() {
            state.isRunning = false;
            if(state.timerId) {
                clearInterval(state.timerId);
                state.timerId = null;
            }
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
            toggleAmbientSound(false);
            try {
                if (Tone.Transport.state === 'started') Tone.Transport.pause();
            } catch (e) { console.warn('Error pausing Transport', e); }
        }

        function resetTimer() {
            pauseTimer();
            if (!currentGameState.inMultiplayer || currentGameState.mode !== 'cooperative') {
                clearGrove();
            }
            changeSpeed(1);
            state.pomodoroCount = 0;
            switchMode('focus');
        }

        // --- 3D FOREST LOGIC ---
        function getHeightAt(x, y) {
            const floorSize = 200;
            const detailScale = 0.1;
            const peakHeight = 20;

            let height = 0;
            height += simplex.noise2D(x * detailScale * 0.5, y * detailScale * 0.5) * 0.5;
            height += simplex.noise2D(x * detailScale * 1.5, y * detailScale * 1.5) * 0.25;
            height += simplex.noise2D(x * detailScale * 4, y * detailScale * 4) * 0.1;
            height = (height + 1) / 2;
            height = Math.pow(height, 1.5);

            const yNormalized = (y + floorSize / 2) / floorSize;
            const slopeHeight = peakHeight * Math.pow(yNormalized, 2);
            return height * peakHeight * 0.5 + slopeHeight;
        }

        function addVegetation() {
            shrubsGroup.clear();
            flowersGroup.clear();

            const bushGeometry = new THREE.SphereGeometry(1.2, 8, 8);
            const bushMaterial = new THREE.MeshStandardMaterial({ color: 0x2E7D32, roughness: 1 });
            for (let i = 0; i < 200; i++) {
                const bush = new THREE.Mesh(bushGeometry, bushMaterial.clone());
                bush.material.color.setHSL(0.33 + Math.random() * 0.05, 0.6, 0.3 + Math.random() * 0.2);

                const x = (Math.random() - 0.5) * 180;
                const z = (Math.random() - 0.5) * 180;
                const height = getHeightAt(x, -z); 
                
                if (height > 0.2) { 
                    bush.position.set(x, height + 0.5, z);
                    bush.castShadow = true;
                    shrubsGroup.add(bush);
                }
            }

            const petalColors = [0xff4d6d, 0xffd60a, 0x8ac926, 0x00b4d8, 0xffb5e8];
            const stemMaterial = new THREE.MeshStandardMaterial({ color: 0x388e3c });
            for (let i = 0; i < 400; i++) {
                const stemGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.5);
                const stem = new THREE.Mesh(stemGeometry, stemMaterial);
                const flower = new THREE.Group();

                const petalGeometry = new THREE.SphereGeometry(0.15, 8, 8);
                const petalMaterial = new THREE.MeshStandardMaterial({ color: petalColors[Math.floor(Math.random() * petalColors.length)] });
                const petal = new THREE.Mesh(petalGeometry, petalMaterial);
                petal.position.y = 0.3;
                flower.add(stem);
                flower.add(petal);

                const x = (Math.random() - 0.5) * 180;
                const z = (Math.random() - 0.5) * 180;
                const height = getHeightAt(x, -z); 
                
                if (height > 0.2) {
                    flower.position.set(x, height + 0.25, z);
                    flower.rotation.y = Math.random() * Math.PI * 2;
                    flowersGroup.add(flower);
                }
            }
        }

        function createPineTree() {
            const tree = new THREE.Group();
            tree.userData.treeType = 'pine';
            const trunkHeight = 5 + (Math.random() - 0.5) * 2;
            const trunkGeo = new THREE.CylinderGeometry(0.2, 0.4, trunkHeight, 8);
            trunkGeo.translate(0, trunkHeight / 2, 0);
            const trunkMat = new THREE.MeshStandardMaterial({ color: 0x4a2e23 });
            const trunk = new THREE.Mesh(trunkGeo, trunkMat);
            trunk.castShadow = true;
            tree.add(trunk);
            
            const leafLevels = 3;
            for (let i = 0; i < leafLevels; i++) {
                const leafRadius = 2 - i * 0.5;
                const leafHeight = 2.5 - i * 0.5;
                const leafGeo = new THREE.ConeGeometry(leafRadius, leafHeight, 8);
                const leafMat = new THREE.MeshStandardMaterial({ color: 0x228b22 });
                leafMat.color.setHSL(0.3, 0.6, 0.3 + Math.random() * 0.1);
                const leaves = new THREE.Mesh(leafGeo, leafMat);
                leaves.position.y = trunkHeight + i * 1.0 - 1 + leafHeight/2;
                leaves.castShadow = true;
                tree.add(leaves);
            }
            return tree;
        }

        function createBroadleafTree() {
            const tree = new THREE.Group();
            tree.userData.treeType = 'broadleaf';
            const trunkHeight = 4 + Math.random() * 3;
            const trunkGeo = new THREE.CylinderGeometry(0.3, 0.35, trunkHeight, 8);
            trunkGeo.translate(0, trunkHeight / 2, 0);
            const trunkMat = new THREE.MeshStandardMaterial({ color: 0x6a4e43 });
            const trunk = new THREE.Mesh(trunkGeo, trunkMat);
            trunk.castShadow = true;
            tree.add(trunk);

            const crownGeo = new THREE.SphereGeometry(2.5, 8, 6);
            const crownMat = new THREE.MeshStandardMaterial({ color: 0x3a9940 });
            crownMat.color.setHSL(0.35, 0.5, 0.4 + Math.random() * 0.1);
            const crown = new THREE.Mesh(crownGeo, crownMat);
            crown.position.y = trunkHeight + 1.5;
            crown.scale.y = 0.8;
            crown.castShadow = true;
            tree.add(crown);

            return tree;
        }

        function createSpecialTree() {
            const tree = new THREE.Group();
             tree.userData.treeType = 'special';
            const trunkHeight = 5 + (Math.random() - 0.5) * 2;
            const trunkGeo = new THREE.CylinderGeometry(0.2, 0.3, trunkHeight, 8);
            trunkGeo.translate(0, trunkHeight / 2, 0);
            const trunkMat = new THREE.MeshStandardMaterial({ color: 0x4f3a30 });
            const trunk = new THREE.Mesh(trunkGeo, trunkMat);
            trunk.castShadow = true;
            tree.add(trunk);
            
            const leafGeo = new THREE.SphereGeometry(0.5, 6, 4);
            const leafBaseColor = new THREE.Color(0xffc2d1);

            for (let i = 0; i < 20; i++) {
                const leafMat = new THREE.MeshStandardMaterial({ color: leafBaseColor });
                leafMat.color.offsetHSL(0, (Math.random() - 0.5) * 0.2, (Math.random() - 0.5) * 0.1);
                const leaf = new THREE.Mesh(leafGeo, leafMat);
                
                const radius = Math.random() * 2.5;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos((Math.random() * 2) - 1);

                leaf.position.set(
                    radius * Math.sin(phi) * Math.cos(theta),
                    trunkHeight + (radius * Math.cos(phi)) * 0.7,
                    radius * Math.sin(phi) * Math.sin(theta)
                );
                
                leaf.castShadow = true;
                tree.add(leaf);
            }
            
            return tree;
        }

        function createTree(type = 'random') {
             if (type === 'random') {
                const treeType = Math.random();
                if (treeType < 0.6) return createPineTree();
                return createBroadleafTree();
             }
             if(type === 'pine') return createPineTree();
             if(type === 'broadleaf') return createBroadleafTree();
             if(type === 'special') return createSpecialTree();
        }
        
        function clearGrove() {
            grove.forEach(tree => {
                scene.remove(tree);
                tree.traverse(object => {
                    if (object.isMesh) {
                        if (object.geometry) object.geometry.dispose();
                        if (object.material) {
                            if (Array.isArray(object.material)) {
                                object.material.forEach(material => material.dispose());
                            } else {
                                object.material.dispose();
                            }
                        }
                    }
                });
            });
            grove = [];
        }
        
        async function growATree({ isSpecial = false, taskId = null } = {}) {
            
            const radius = 10 + Math.random() * 25;
            const angle = Math.random() * Math.PI * 2;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;
            const y = getHeightAt(x,-z);

            if (y <= 0.2) return; // Don't grow tree if position is invalid

            const treeType = isSpecial ? 'special' : (Math.random() < 0.6 ? 'pine' : 'broadleaf');
            const baseScale = 1.0 + (Math.random() - 0.5) * 0.4;
            const targetScale = isSpecial ? baseScale * 1.15 : baseScale;

            const treeData = {
                type: treeType,
                position: { x, y, z },
                scale: targetScale,
                taskId: taskId,
                owner: userId,
                id: THREE.MathUtils.generateUUID()
            };
            
            // If in a multiplayer game, send data to Firestore. Otherwise, grow locally.
            if (currentGameState.inMultiplayer) {
                await updateFirestoreWithNewTree(treeData);
            } else {
                addTreeToScene(treeData);
            }
        }
        
        function addTreeToScene(treeData) {
            // Avoid adding duplicate trees
            if (grove.some(tree => tree.userData.id === treeData.id)) return;
        
            const tree = createTree(treeData.type);
            
            if (treeData.taskId) {
                tree.userData.taskId = treeData.taskId;
            }
            tree.userData.id = treeData.id;
            
            tree.position.set(treeData.position.x, treeData.position.y, treeData.position.z);
            tree.scale.set(0.01, 0.01, 0.01);
            tree.userData.isGrowing = true;
            tree.userData.targetScale = treeData.scale;
            
            grove.push(tree);
            scene.add(tree);
        }

        // --- SPEED CONTROLS ---
        function changeSpeed(newSpeed) {
            state.timeScale = newSpeed;

            document.querySelectorAll('#speed-controls .speed-button').forEach(btn => {
                btn.classList.remove('active');
                if (parseFloat(btn.dataset.speed) === newSpeed) {
                    btn.classList.add('active');
                }
            });

            if (state.isRunning) {
                pauseTimer();
                startTimer();
            }
        }

        // --- BIOME/THEME SELECTOR ---
        const biomes = [
             { name: 'Forest', zenith: 0x87ceeb, horizon: 0xe0f2ff, ambient: 0xcccccc, sun: 0xffffff, sunColor: 0xFDB813 },
             { name: 'Desert', zenith: 0xfab1a0, horizon: 0xffd3b6, ambient: 0xaaaaaa, sun: 0xfff5e1, sunColor: 0xFDB813 },
             { name: 'Night', zenith: 0x0c0a1c, horizon: 0x2c3e50, ambient: 0x404060, sun: 0x606080, sunColor: 0xaaaaff }
        ];
        let currentBiomeIndex = -1;

        function changeBiome() {
            currentBiomeIndex = (currentBiomeIndex + 1) % biomes.length;
            const biome = biomes[currentBiomeIndex];
            
            skybox.material.uniforms.topColor.value.set(biome.zenith);
            skybox.material.uniforms.bottomColor.value.set(biome.horizon);
            sunMesh.material.color.set(biome.sunColor);
            ambientLight.color.set(biome.ambient);
            sunLight.color.set(biome.sun);
        }

        // --- AUDIO ---
        let soundSources = {};
        let notificationSynth;
        let currentSound = 'mute';
        let isAudioReady = false;

        function initAudio() {
            const masterGain = new Tone.Gain(1).toDestination();
            const rainSynth = new Tone.NoiseSynth({ noise: { type: "brown" }, envelope: { attack: 0.01, sustain: 1 }, volume: -12 });
            const rainGain = new Tone.Gain(0).connect(masterGain);
            rainSynth.connect(rainGain);
            soundSources.rain = {
                start: () => {
                    try { if (rainSynth.state !== 'started') rainSynth.triggerAttack(); } catch(e){}
                    rainGain.gain.rampTo(1, 0.8);
                },
                stop: () => {
                    rainGain.gain.rampTo(0, 0.6);
                },
                setVolume: (v) => { try { rainSynth.volume.value = v; } catch(e){} }
            };
            const whiteSynth = new Tone.NoiseSynth({ noise: { type: "white" }, envelope: { attack: 0.01, sustain: 1 }, volume: -24 });
            const whiteGain = new Tone.Gain(0).connect(masterGain);
            whiteSynth.connect(whiteGain);
            soundSources.white_noise = {
                start: () => {
                    try { if (whiteSynth.state !== 'started') whiteSynth.triggerAttack(); } catch(e){}
                    whiteGain.gain.rampTo(1, 0.6);
                },
                stop: () => {
                    whiteGain.gain.rampTo(0, 0.4);
                },
                setVolume: (v) => { try { whiteSynth.volume.value = v; } catch(e){} }
            };
            const forestGain = new Tone.Gain(0).connect(masterGain);
            const wind = new Tone.Noise('brown');
            const windFilter = new Tone.Filter(800, 'lowpass');
            const windLFO = new Tone.LFO(0.06, 500, 2000).start();
            windLFO.connect(windFilter.frequency);
            const windGain = new Tone.Gain(0).connect(forestGain);
            wind.chain(windFilter, windGain);
            const windChorus = new Tone.Chorus(0.1, 2.5, 0.5).start();
            windFilter.connect(windChorus);
            windChorus.connect(forestGain);
            const birdReverb = new Tone.Reverb({ decay: 2.4, wet: 0.25 }).connect(forestGain);
            const birdLoops = [];
            const birdSynths = [];
            for (let i = 0; i < 4; i++) {
                const synth = new Tone.FMSynth({
                    harmonicity: 1.6 + Math.random() * 0.8,
                    modulationIndex: 8 + Math.random() * 6,
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.001, decay: 0.1 + Math.random() * 0.25, sustain: 0.05, release: 0.2 + Math.random() * 0.4 },
                    volume: -20 - Math.random() * 6
                });
                const pan = new Tone.Panner(Math.random() * 2 - 1);
                const gain = new Tone.Gain(0).connect(birdReverb);
                synth.chain(pan, gain);
                birdSynths.push({ synth, pan, gain });
                const loop = new Tone.Loop(time => {
                    if (Math.random() < 0.45) {
                        const baseFreq = 600 + Math.random() * 800;
                        const detune = (Math.random() - 0.5) * 200;
                        const dur = 0.06 + Math.random() * 0.18;
                        try { synth.set({ detune }); } catch(e){}
                        try { pan.pan.rampTo(Math.random() * 2 - 1, 0.2); } catch(e){}
                        try { synth.triggerAttackRelease(baseFreq, dur, time); } catch(e){}
                    }
                }, 0.6 + Math.random() * 1.4);
                birdLoops.push(loop);
            }
            try { wind.start(); } catch(e){}
            soundSources.forest = {
                start: async () => {
                    if (Tone.Transport.state !== 'started') await Tone.Transport.start();
                    windGain.gain.cancelScheduledValues();
                    windGain.gain.rampTo(1, 1.0);
                    forestGain.gain.cancelScheduledValues();
                    forestGain.gain.rampTo(1, 1.2);
                    birdSynths.forEach((b, idx) => {
                        b.gain.gain.cancelScheduledValues();
                        b.gain.gain.rampTo(0.7 + Math.random() * 0.6, 0.6 + idx * 0.05);
                    });
                    birdLoops.forEach((l, idx) => {
                        const when = Tone.now() + idx * 0.15;
                        try { if (l.state !== 'started') l.start(when); } catch(e){}
                    });
                },
                stop: () => {
                    forestGain.gain.cancelScheduledValues();
                    forestGain.gain.rampTo(0, 0.8);
                    windGain.gain.cancelScheduledValues();
                    windGain.gain.rampTo(0, 0.6);
                    birdSynths.forEach(b => {
                        b.gain.gain.cancelScheduledValues();
                        b.gain.gain.rampTo(0, 0.5);
                    });
                },
                setVolume: (v) => {
                    birdSynths.forEach(b => { try { b.synth.volume.value = -12 - (100 - v) * 0.24; } catch(e){} });
                    windGain.gain.rampTo(0.25 * (v / 50), 0.2);
                }
            };
            notificationSynth = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 },
                volume: -10
            }).toDestination();
            soundSources._internal = { masterGain };
            updateVolume();
        }

        async function startAudioContext() {
            if (isAudioReady) return;
            await Tone.start();
            if (Tone.Transport.state !== 'started') Tone.Transport.start();
            isAudioReady = true;
            console.log("Audio context + Transport started.");
            updateVolume();
        }

        function stopAllAmbientSounds() {
            if (!isAudioReady) return;
            Object.keys(soundSources).forEach(key => {
                if (key === '_internal' || !soundSources[key]) return;
                const src = soundSources[key];
                if (src && typeof src.stop === 'function') {
                    try { src.stop(); } catch (e) { /* ignore */ }
                }
            });
        }
        
        function playCurrentSound() {
            if (!isAudioReady) return;
            stopAllAmbientSounds();
            const src = soundSources[currentSound];
            if (src && typeof src.start === 'function') {
                try { src.start(); } catch (e) { console.warn('Error starting sound', e); }
            }
        }
        
        function toggleAmbientSound(play) {
             if (play) {
                if (Tone.Transport.state !== 'started') Tone.Transport.start();
                playCurrentSound();
            } else {
                stopAllAmbientSounds();
                if (Tone.Transport.state === 'started') Tone.Transport.pause();
            }
        }

        function updateVolume(volumeValue) {
            const v = (typeof volumeValue === 'number') ? volumeValue : (document.getElementById ? parseFloat(document.getElementById('volume-slider')?.value ?? 50) : 50);
            const dB = -40 + (v / 100) * 40;
            if (isAudioReady) Tone.Destination.volume.value = dB;

            if (soundSources.forest && typeof soundSources.forest.setVolume === 'function') soundSources.forest.setVolume(v);
            if (soundSources.rain && typeof soundSources.rain.setVolume === 'function') soundSources.rain.setVolume(-12 + (v - 50) * 0.2);
            if (soundSources.white_noise && typeof soundSources.white_noise.setVolume === 'function') soundSources.white_noise.setVolume(-24 + (v - 50) * 0.2);
        }

        function playNotification() {
            if (!isAudioReady) return;
            notificationSynth.triggerAttackRelease("C5", "8n", Tone.now());
            notificationSynth.triggerAttackRelease("G5", "8n", Tone.now() + 0.2);
        }

        // --- TASK LIST & TRANSLATIONS---
        let tasks = [];
        const translations = {
             es: {
                 aiTutorTitle: "‚ú® Tutor IA",
                 aiTutorDescription: "¬øAtascado en un problema? Descr√≠belo y la IA te dar√° una explicaci√≥n simple.",
                 aiTutorPlaceholder: "Ej: ¬øPor qu√© el cielo es azul?",
                 aiTutorGenerateBtn: "Explicar Concepto",
                 aiTutorLoading: "Pensando...",
                 todoTitle: "Lista de Tareas",
                 todoPlaceholder: "A√±adir nueva tarea...",
                 settingsTitle: "Configuraci√≥n",
                 focusLabel: "Enfoque",
                 shortBreakLabel: "Descanso Corto",
                 longBreakLabel: "Descanso Largo",
                 multiplayer: "Multijugador",
                 biome: "Bioma",
                 music: "M√∫sica",
                 createGame: "Crear Partida",
                 joinGame: "Unirse a Partida",
                 selectMode: "Seleccionar Modo",
                 cooperativeMode: "Cooperativo",
                 versusMode: "Lucha",
                 back: "Volver",
                 waitingForPlayer: "Esperando jugador...",
                 shareCode: "Comparte este c√≥digo con un amigo:",
                 copied: "¬°Copiado!",
                 enterCode: "Introduce el c√≥digo de la partida",
                 join: "Unirse",
                 host: "Anfitri√≥n",
                 guest: "Invitado",
                 saveLoadGame: "Guardar/Cargar Partida",
                 saveLoadDesc: "Exporta el estado de tu partida multijugador para continuarla m√°s tarde.",
                 exportGame: "Exportar Partida",
                 importGame: "Importar Partida (Anfitri√≥n)"
             },
             en: {
                 aiTutorTitle: "‚ú® AI Tutor",
                 aiTutorDescription: "Stuck on a problem? Describe it and the AI will give you a simple explanation.",
                 aiTutorPlaceholder: "E.g., Why is the sky blue?",
                 aiTutorGenerateBtn: "Explain Concept",
                 aiTutorLoading: "Thinking...",
                 todoTitle: "To-Do List",
                 todoPlaceholder: "Add a new task...",
                 settingsTitle: "Settings",
                 focusLabel: "Focus",
                 shortBreakLabel: "Short Break",
                 longBreakLabel: "Long Break",
                 multiplayer: "Multiplayer",
                 biome: "Biome",
                 music: "Music",
                 createGame: "Create Game",
                 joinGame: "Join Game",
                 selectMode: "Select Mode",
                 cooperativeMode: "Cooperative",
                 versusMode: "Versus",
                 back: "Back",
                 waitingForPlayer: "Waiting for player...",
                 shareCode: "Share this code with a friend:",
                 copied: "Copied!",
                 enterCode: "Enter the game code",
                 join: "Join",
                 host: "Host",
                 guest: "Guest",
                 saveLoadGame: "Save/Load Game",
                 saveLoadDesc: "Export your multiplayer game state to continue it later.",
                 exportGame: "Export Game",
                 importGame: "Import Game (Host)"
             },
             fr: { // (A√±adir m√°s traducciones si es necesario)
                aiTutorTitle: "‚ú® Tuteur IA",
                aiTutorDescription: "Bloqu√© sur un probl√®me ? D√©crivez-le et l'IA vous donnera une explication simple.",
                aiTutorPlaceholder: "Ex : Pourquoi le ciel est-il bleu ?",
                aiTutorGenerateBtn: "Expliquer le Concept",
                aiTutorLoading: "R√©flexion...",
                todoTitle: "Liste de T√¢ches",
                todoPlaceholder: "Ajouter une nouvelle t√¢che...",
                settingsTitle: "Param√®tres",
                focusLabel: "Concentration",
                shortBreakLabel: "Pause Courte",
                longBreakLabel: "Pause Longue",
                multiplayer: "Multijoueur",
                biome: "Biome",
                music: "Musique"
             },
              zh: {
                aiTutorTitle: "‚ú® AIÂØºÂ∏à",
                aiTutorDescription: "ÈÅáÂà∞ÈóÆÈ¢ò‰∫ÜÂêóÔºüÊèèËø∞‰∏Ä‰∏ãÔºåAI‰ºöÁªô‰Ω†‰∏Ä‰∏™ÁÆÄÂçïÁöÑËß£ÈáäËÆ©‰Ω†ÁªßÁª≠ÂâçËøõ„ÄÇ",
                aiTutorPlaceholder: "‰æãÂ¶ÇÔºöÂ§©Á©∫‰∏∫‰ªÄ‰πàÊòØËìùËâ≤ÁöÑÔºü",
                aiTutorGenerateBtn: "Ëß£ÈáäÊ¶ÇÂøµ",
                aiTutorLoading: "ÊÄùËÄÉ‰∏≠...",
                todoTitle: "ÂæÖÂäû‰∫ãÈ°π",
                todoPlaceholder: "Ê∑ªÂä†Êñ∞‰ªªÂä°...",
                settingsTitle: "ËÆæÁΩÆ",
                focusLabel: "‰∏ìÊ≥®",
                shortBreakLabel: "Áü≠ÊöÇ‰ºëÊÅØ",
                longBreakLabel: "ÈïøÊó∂Èó¥‰ºëÊÅØ",
                multiplayer: "Â§ö‰∫∫Ê∏∏Êàè",
                biome: "ÁîüÁâ©Áæ§Á≥ª",
                music: "Èü≥‰πê"
            },
            hi: {
                aiTutorTitle: "‚ú® ‡§è‡§Ü‡§à ‡§ü‡•ç‡§Ø‡•Ç‡§ü‡§∞",
                aiTutorDescription: "‡§ï‡§ø‡§∏‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Æ‡•á‡§Ç ‡§´‡§Ç‡§∏ ‡§ó‡§è ‡§π‡•à‡§Ç? ‡§á‡§∏‡§ï‡§æ ‡§µ‡§∞‡•ç‡§£‡§® ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§è‡§Ü‡§à ‡§Ü‡§™‡§ï‡•ã ‡§è‡§ï ‡§∏‡§∞‡§≤ ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ ‡§¶‡•á‡§ó‡§æ‡•§",
                aiTutorPlaceholder: "‡§ú‡•à‡§∏‡•á: ‡§Ü‡§ï‡§æ‡§∂ ‡§®‡•Ä‡§≤‡§æ ‡§ï‡•ç‡§Ø‡•ã‡§Ç ‡§π‡•à?",
                aiTutorGenerateBtn: "‡§Ö‡§µ‡§ß‡§æ‡§∞‡§£‡§æ ‡§∏‡§Æ‡§ù‡§æ‡§ì",
                aiTutorLoading: "‡§∏‡•ã‡§ö ‡§∞‡§π‡§æ ‡§π‡•à...",
                todoTitle: "‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§∏‡•Ç‡§ö‡•Ä",
                todoPlaceholder: "‡§è‡§ï ‡§®‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ú‡•ã‡§°‡§º‡•á‡§Ç...",
                settingsTitle: "‡§∏‡§Æ‡§æ‡§Ø‡•ã‡§ú‡§®",
                focusLabel: "‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞",
                shortBreakLabel: "‡§õ‡•ã‡§ü‡§æ ‡§µ‡§ø‡§∞‡§æ‡§Æ",
                longBreakLabel: "‡§≤‡§Ç‡§¨‡§æ ‡§µ‡§ø‡§∞‡§æ‡§Æ",
                multiplayer: "‡§Æ‡§≤‡•ç‡§ü‡•Ä‡§™‡•ç‡§≤‡•á‡§Ø‡§∞",
                biome: "‡§¨‡§æ‡§Ø‡•ã‡§Æ",
                music: "‡§∏‡§Ç‡§ó‡•Ä‡§§"
            }
        };

        function applyLanguage(lang) {
            state.currentLang = lang;
            document.documentElement.lang = lang;
            localStorage.setItem('language', lang);
            
            const code = {es: 'es', en: 'us', fr: 'fr', zh: 'cn', hi: 'in'}[lang] || 'es';
            languageBtn.style.backgroundImage = `url('https://flagcdn.com/w40/${code}.png')`;

            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if(translations[lang] && translations[lang][key]) {
                    const translation = translations[lang][key];
                    if (el.placeholder !== undefined && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA')) {
                        el.placeholder = translation;
                    } else if (el.title !== undefined && el.tagName === 'BUTTON') {
                        el.title = translation;
                    }
                    else {
                        el.textContent = translation;
                    }
                }
            });
        }


        function renderTasks() {
            taskList.innerHTML = '';
            tasks.forEach((task) => {
                const li = document.createElement('li');
                li.dataset.id = task.id;
                
                li.innerHTML = `
                    <input type="checkbox" ${task.completed ? 'checked' : ''}>
                    <span class="task-text ${task.completed ? 'completed' : ''}">${task.text}</span>
                    <button class="delete-task">&times;</button>
                `;
                taskList.appendChild(li);
            });
        }

        function saveTasks() {
            localStorage.setItem('focusGroveTasks', JSON.stringify(tasks));
        }

        function loadTasks() {
            const storedTasks = localStorage.getItem('focusGroveTasks');
            if (storedTasks) {
                tasks = JSON.parse(storedTasks);
                renderTasks();
                // We will let the multiplayer sync handle showing initial trees
                if(!currentGameState.inMultiplayer) {
                    tasks.forEach(task => {
                        if (task.completed) {
                            growATree({ isSpecial: true, taskId: task.id });
                        }
                    });
                }
            }
        }
        
        function addTask() {
            const text = newTaskInput.value.trim();
            if (text) {
                 tasks.push({ id: Date.now(), text, completed: false });
                newTaskInput.value = '';
                saveTasks();
                renderTasks();
            }
        }
        
        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                
                if (task.completed) {
                    growATree({ isSpecial: true, taskId: id });
                } else {
                    removeTaskTree(id);
                }

                saveTasks();
                renderTasks();
            }
        }
        
        function deleteTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task && task.completed) {
                removeTaskTree(id);
            }
            tasks = tasks.filter(t => t.id !== id);
            saveTasks();
            renderTasks();
        }
        
        async function removeTaskTree(taskId) {
            if (currentGameState.inMultiplayer) {
                const gameRef = doc(db, `artifacts/${appId}/public/data/games`, currentGameState.gameId);
                const gameSnap = await getDoc(gameRef);
                if (!gameSnap.exists()) return;

                const gameData = gameSnap.data();
                let treeToRemove = null;

                if (currentGameState.mode === 'cooperative') {
                    treeToRemove = gameData.sharedTrees.find(t => t.taskId === taskId);
                    if (treeToRemove) {
                        await updateDoc(gameRef, { sharedTrees: arrayRemove(treeToRemove) });
                    }
                } else if (currentGameState.mode === 'versus') {
                    treeToRemove = gameData.players[userId]?.trees.find(t => t.taskId === taskId);
                    if (treeToRemove) {
                        await updateDoc(gameRef, { [`players.${userId}.trees`]: arrayRemove(treeToRemove) });
                    }
                }
            } else {
                const treeToRemove = grove.find(tree => tree.userData.taskId === taskId);
                if (treeToRemove) {
                    removeTreeObjectFromScene(treeToRemove);
                    grove = grove.filter(tree => tree.uuid !== treeToRemove.uuid);
                }
            }
        }


        function removeTreeObjectFromScene(treeObject) {
             scene.remove(treeObject);
            treeObject.traverse(object => {
                if (object.isMesh) {
                    if (object.geometry) object.geometry.dispose();
                    if (object.material) {
                        if (Array.isArray(object.material)) {
                            object.material.forEach(material => material.dispose());
                        } else {
                            object.material.dispose();
                        }
                    }
                }
            });
        }
        
        async function getTutorExplanation() {
            const userQuery = aiTutorPromptInput.value;
            const systemPrompt = "Eres un tutor amigable y experto. Tu objetivo es explicar conceptos dif√≠ciles de una manera muy simple y f√°cil de entender. Usa analog√≠as y un lenguaje claro.";
            
            aiTutorLoading.classList.remove('hidden');
            aiTutorOutput.innerHTML = '';
            aiTutorGenerateBtn.disabled = true;

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    aiTutorOutput.innerHTML = text.split('\n').filter(p => p.trim()).map(p => `<p class="mb-2">${p}</p>`).join('');
                } else {
                    throw new Error("No text returned from API.");
                }
            } catch(error) {
                console.error("Gemini API error:", error);
                aiTutorOutput.innerHTML = `<p class="text-red-500">Error al obtener la explicaci√≥n.</p>`;
            } finally {
                aiTutorLoading.classList.add('hidden');
                aiTutorGenerateBtn.disabled = false;
            }
        }

        // --- CREDIT LINE ---
        function addCreditLine() {
            if (document.getElementById('credit-line')) return;
            const credit = document.createElement('div');
            credit.id = 'credit-line';
            credit.textContent = 'Hecho por Daniel Terroba Alcala';
            credit.style.position = 'fixed';
            credit.style.bottom = '10px';
            credit.style.right = '10px';
            credit.style.fontSize = '12px';
            credit.style.color = 'rgba(255, 255, 255, 0.3)';
            credit.style.pointerEvents = 'none';
            credit.style.zIndex = '1001';
            document.body.appendChild(credit);
        }
        
        // --- MULTIPLAYER LOGIC ---

        function generateGameId() {
            const ADJECTIVES = ['ROJO', 'VERDE', 'AZUL', 'GRAN', 'LEAL', 'VELOZ'];
            const NOUNS = ['LEON', 'TIGRE', 'SOL', 'LUNA', 'RIO', 'REY'];
            const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
            const noun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
            const num = Math.floor(Math.random() * 90) + 10;
            return `${adj}-${noun}-${num}`;
        }
        
        function showMultiplayerView(viewId) {
            [multiplayerInitialView, multiplayerHostView, multiplayerWaitingView, multiplayerJoinView].forEach(v => v.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }
        
        async function hostGame(mode, importedData = null) {
            if (!userId) {
                alert("Error de autenticaci√≥n. Por favor, recarga la p√°gina.");
                return;
            }
            const gameId = generateGameId();
            
            let initialData;
            if (importedData) {
                initialData = { ...importedData, gameId, hostId: userId, guestId: null, status: 'waiting' };
            } else {
                 initialData = {
                    gameId: gameId,
                    mode: mode,
                    status: 'waiting',
                    hostId: userId,
                    guestId: null,
                    sharedTrees: [],
                    players: {
                        [userId]: { pomodoros: 0, trees: [] }
                    }
                };
            }

            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            await setDoc(gameRef, initialData);

            listenToGameChanges(gameId);
            currentGameState.inMultiplayer = true;
            currentGameState.isHost = true;
            currentGameState.gameId = gameId;
            currentGameState.mode = mode;
            
            gameCodeDisplay.textContent = gameId;
            showMultiplayerView('multiplayer-waiting');
        }

        async function joinGame(gameId) {
             if (!userId) {
                alert("Error de autenticaci√≥n. Por favor, recarga la p√°gina.");
                return;
            }
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            const gameSnap = await getDoc(gameRef);

            if (gameSnap.exists() && gameSnap.data().status === 'waiting') {
                await updateDoc(gameRef, {
                    guestId: userId,
                    status: 'active',
                    [`players.${userId}`]: { pomodoros: 0, trees: [] }
                });
                listenToGameChanges(gameId);
                currentGameState.inMultiplayer = true;
                currentGameState.isHost = false;
                currentGameState.gameId = gameId;
                currentGameState.mode = gameSnap.data().mode;
                multiplayerModal.classList.remove('active');
            } else {
                alert("Partida no encontrada o ya est√° llena.");
            }
        }

        function listenToGameChanges(gameId) {
             if(currentGameState.unsubscribe) currentGameState.unsubscribe(); 
            
            localStorage.setItem('focusGroveLastGame', gameId);
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            
            currentGameState.unsubscribe = onSnapshot(gameRef, (doc) => {
                if (!doc.exists()) {
                    console.log("Game session ended.");
                    leaveGame();
                    return;
                }

                const gameData = doc.data();

                if (currentGameState.isHost && gameData.status === 'waiting' && gameData.guestId) {
                    multiplayerModal.classList.remove('active');
                }
                
                if (gameData.mode === 'cooperative') {
                    syncCoopGrove(gameData.sharedTrees || []);
                    versusScoreboard.classList.add('hidden');
                } else if (gameData.mode === 'versus') {
                    syncVersusState(gameData.players);
                }
            });
        }
        
        function syncCoopGrove(treesFromDb) {
            treesFromDb.forEach(treeData => {
                if (!grove.some(localTree => localTree.userData.id === treeData.id)) {
                    addTreeToScene(treeData);
                }
            });

            grove.slice().forEach(localTree => {
                if (!treesFromDb.some(dbTree => dbTree.id === localTree.userData.id)) {
                    removeTreeObjectFromScene(localTree);
                    grove = grove.filter(t => t.uuid !== localTree.uuid);
                }
            });
        }
        
        function syncVersusState(playersData) {
            versusScoreboard.classList.remove('hidden');
            
            const myData = playersData[userId];
            const myTreesFromDb = myData?.trees || [];

            // Add new trees from DB
            myTreesFromDb.forEach(treeData => {
                if (!grove.some(localTree => localTree.userData.id === treeData.id)) {
                    addTreeToScene(treeData);
                }
            });

            // Remove local trees that are no longer in DB
            grove.slice().forEach(localTree => {
                if (!myTreesFromDb.some(dbTree => dbTree.id === localTree.userData.id)) {
                    removeTreeObjectFromScene(localTree);
                    grove = grove.filter(t => t.uuid !== localTree.uuid);
                }
            });
            
            // Update scoreboard
            const hostId = currentGameState.isHost ? userId : Object.keys(playersData).find(id => id !== userId);
            const guestId = currentGameState.isHost ? Object.keys(playersData).find(id => id !== userId) : userId;

            const hostScore = (hostId && playersData[hostId]) ? playersData[hostId].pomodoros : 0;
            const guestScore = (guestId && playersData[guestId]) ? playersData[guestId].pomodoros : 0;

            document.querySelector('#player1-score p').textContent = `${hostScore} üçÖ`;
            document.querySelector('#player2-score p').textContent = `${guestScore} üçÖ`;
            document.querySelector('#player1-score h4').setAttribute('data-translate-key', 'host');
            document.querySelector('#player2-score h4').setAttribute('data-translate-key', 'guest');
            
            applyLanguage(state.currentLang);
        }

        async function updateFirestoreWithNewTree(treeData) {
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, currentGameState.gameId);
            
            if (currentGameState.mode === 'cooperative') {
                await updateDoc(gameRef, { sharedTrees: arrayUnion(treeData) });
            } else if (currentGameState.mode === 'versus') {
                const updates = {
                    [`players.${userId}.trees`]: arrayUnion(treeData)
                };
                // Only increment pomodoro count for non-task trees
                if (!treeData.taskId) {
                    updates[`players.${userId}.pomodoros`] = increment(1);
                }
                await updateDoc(gameRef, updates);
            }
        }
        
        function leaveGame() {
            if (currentGameState.unsubscribe) {
                currentGameState.unsubscribe();
            }
             currentGameState = {
                inMultiplayer: false,
                isHost: false,
                gameId: null,
                mode: null,
                unsubscribe: null,
            };
            localStorage.removeItem('focusGroveLastGame');
            versusScoreboard.classList.add('hidden');
            clearGrove();
            resetTimer();
        }

        async function exportGame() {
            if (!currentGameState.inMultiplayer) {
                alert("Debes estar en una partida multijugador para exportarla.");
                return;
            }
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, currentGameState.gameId);
            const gameSnap = await getDoc(gameRef);
            if (gameSnap.exists()) {
                const data = JSON.stringify(gameSnap.data(), null, 2);
                const blob = new Blob([data], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `focus-grove-game-${currentGameState.gameId}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        function importGame(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if(importedData.mode && importedData.players) {
                        leaveGame();
                        await hostGame(importedData.mode, importedData);
                    } else {
                        alert("Archivo JSON inv√°lido.");
                    }
                } catch (error) {
                    console.error("Error al importar la partida:", error);
                    alert("Error al leer el archivo JSON.");
                }
            };
            reader.readAsText(file);
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            playPauseBtn.addEventListener('click', () => {
                startAudioContext();
                if (state.isRunning) {
                    pauseTimer();
                } else {
                    startTimer();
                }
            });
            resetBtn.addEventListener('click', resetTimer);
            
            fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.error(`Error al intentar activar el modo de pantalla completa: ${err.message} (${err.name})`);
                    });
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            });

            // Modals
            settingsBtn.addEventListener('click', () => settingsModal.classList.add('active'));
            tasksBtn.addEventListener('click', () => tasksModal.classList.add('active'));
            aiTutorBtn.addEventListener('click', () => aiTutorModal.classList.add('active'));
            multiplayerBtn.addEventListener('click', () => {
                if(currentGameState.inMultiplayer) {
                    if(confirm("¬øQuieres salir de la partida multijugador actual?")) {
                        leaveGame();
                    }
                } else {
                    multiplayerModal.classList.add('active');
                    showMultiplayerView('multiplayer-initial');
                }
            });
            
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetModalId = e.currentTarget.dataset.target;
                    document.getElementById(targetModalId).classList.remove('active');
                });
            });
            
            [settingsModal, tasksModal, aiTutorModal, multiplayerModal].forEach(modal => {
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if(e.target === modal) modal.classList.remove('active');
                    });
                }
            });
            
            
            workDurationInput.addEventListener('change', updateDurations);
            shortBreakDurationInput.addEventListener('change', updateDurations);
            longBreakDurationInput.addEventListener('change', updateDurations);

            biomeBtn.addEventListener('click', changeBiome);
            
            document.getElementById('speed-controls').addEventListener('click', (e) => {
                if (e.target.matches('.speed-button')) {
                    const newSpeed = parseFloat(e.target.dataset.speed);
                    changeSpeed(newSpeed);
                }
            });
            
            soundMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                soundPanel.classList.toggle('active');
            });

            document.getElementById('sound-buttons').addEventListener('click', (e) => {
                startAudioContext();
                const soundButton = e.target.closest('.sound-button');
                if (soundButton) {
                    currentSound = soundButton.dataset.sound;
                    document.querySelectorAll('.sound-button').forEach(btn => btn.classList.remove('active'));
                    soundButton.classList.add('active');
                    if(state.isRunning) {
                        playCurrentSound();
                    }
                }
            });

            volumeSlider.addEventListener('input', () => updateVolume());

            document.addEventListener('click', (e) => {
                if (soundPanel && !soundPanel.contains(e.target) && !soundMenuBtn.contains(e.target)) {
                    soundPanel.classList.remove('active');
                }
                if (languageDropdown && !languageDropdown.contains(e.target) && !languageBtn.contains(e.target)) {
                    languageDropdown.classList.add('hidden');
                }
                if (mainMenuDropdown && !mainMenuDropdown.contains(e.target) && !mainMenuBtn.contains(e.target)) {
                    mainMenuDropdown.classList.add('hidden');
                }
            });
            
            aiTutorGenerateBtn.addEventListener('click', getTutorExplanation);
            
            languageBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                languageDropdown.classList.toggle('hidden');
            });

            document.querySelectorAll('#language-dropdown .menu-option').forEach(option => {
                option.addEventListener('click', () => {
                    applyLanguage(option.dataset.lang);
                    languageDropdown.classList.add('hidden');
                });
            });

            mainMenuBtn.addEventListener('click', (e) => {
                 e.stopPropagation();
                mainMenuDropdown.classList.toggle('hidden');
            });

            // Tasks Listeners
            newTaskInput.addEventListener('keypress', (e) => {
                if(e.key === 'Enter') {
                    addTask();
                }
            });
            
            taskList.addEventListener('click', (e) => {
                 const deleteBtn = e.target.closest('.delete-task');
                if (deleteBtn) {
                    const id = parseInt(deleteBtn.closest('li').dataset.id);
                    deleteTask(id);
                }

                 const checkbox = e.target.closest('input[type="checkbox"]');
                if (checkbox) {
                     const id = parseInt(checkbox.closest('li').dataset.id);
                     toggleTask(id);
                }
            });
            
            // Multiplayer Listeners
            hostBtn.addEventListener('click', () => showMultiplayerView('multiplayer-host-options'));
            joinBtn.addEventListener('click', () => showMultiplayerView('multiplayer-join'));
            document.querySelectorAll('#back-to-initial-btn, #back-to-initial-btn-2').forEach(btn => {
                btn.addEventListener('click', () => showMultiplayerView('multiplayer-initial'));
            });
            coopModeBtn.addEventListener('click', () => hostGame('cooperative'));
            versusModeBtn.addEventListener('click', () => hostGame('versus'));
            joinGameSubmitBtn.addEventListener('click', () => {
                const code = gameCodeInput.value.trim().toUpperCase();
                if(code) joinGame(code);
            });
            gameCodeDisplay.addEventListener('click', () => {
                navigator.clipboard.writeText(gameCodeDisplay.textContent).then(() => {
                    const feedback = document.getElementById('game-code-copy-feedback');
                    feedback.style.opacity = '1';
                    setTimeout(() => feedback.style.opacity = '0', 1500);
                });
            });

            exportGameBtn.addEventListener('click', exportGame);
            importGameInput.addEventListener('change', importGame);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
        
        // --- ANIMATION LOOP ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            
            if (!document.getElementById('credit-line')) {
                addCreditLine();
            }

            const delta = clock.getDelta();
            controls.update();
            
            // Animate growing trees
            grove.forEach(tree => {
                if (tree.userData.isGrowing) {
                    const scale = tree.scale.x;
                    const targetScale = tree.userData.targetScale;
                    if (scale < targetScale) {
                        const newScale = scale + delta * 0.8; // Growth speed
                        tree.scale.set(newScale, newScale, newScale);
                    } else {
                        tree.scale.set(targetScale, targetScale, targetScale); // Clamp to target
                        tree.userData.isGrowing = false;
                    }
                }
            });

            renderer.render(scene, camera);
        }

        // --- INITIALIZATION ---
        async function main() {
            const deployedFirebaseConfig = {
              apiKey: "AIzaSyDigVtE9WexPsg0gOvjcsuYVO_FX-r__7o",
              authDomain: "interfaces-4bc20.firebaseapp.com",
              projectId: "interfaces-4bc20",
              storageBucket: "interfaces-4bc20.appspot.com",
              messagingSenderId: "1007775332703",
              appId: "1:1007775332703:web:d28af78317f63cfaa75eea",
              measurementId: "G-2XGZ3JEY94"
            };

            const firebaseConfig = typeof __firebase_config !== 'undefined' 
                ? JSON.parse(__firebase_config)
                : deployedFirebaseConfig;

            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid;
                if (!userId) {
                    throw new Error("Authentication failed, user ID is null.");
                }
                
                console.log("Authenticated with user ID:", userId);
                
                multiplayerBtn.disabled = false;
                
                init3D();
                initAudio();
                loadTasks();
                setupEventListeners();
                animate();

                const savedLang = localStorage.getItem('language') || 'es';
                applyLanguage(savedLang);
                switchMode('focus');

            } catch (error) {
                console.error("Initialization Error:", error);
                alert("No se pudo iniciar la aplicaci√≥n. Por favor, recarga la p√°gina.");
            }
        }
        
        main();

    </script>
</body>
</html>


